<mt:setvar name="page_title" value="<__trans phrase="Mail Settings">">
<$mt:setvar name="position_actions_bottom" value="1"$>
<mt:setvar name="system-mail-settings" value="1">

<mt:setvarblock name="system_msg">
<mt:if name="error">
  <mtapp:statusmsg
     id="generic-error"
     class="error"
     can_close="0">
    <mt:var name="error" escape="html">
  </mtapp:statusmsg>
</mt:if>
<mt:if name="test_mail_sent">
  <mtapp:statusmsg
     id="saved"
     class="success">
    <__trans phrase="A test email was sent.">
  </mtapp:statusmsg>
</mt:if>
<mt:if name="saved">
  <mtapp:statusmsg
     id="saved"
     class="success">
    <__trans phrase="Your settings have been saved.">
  </mtapp:statusmsg>
</mt:if>
<mt:if name="config_warning">
  <mtapp:statusmsg
     id="info"
     class="info"
     can_close="0">
    <mt:var name="config_warning">
  </mtapp:statusmsg>
</mt:if>
</mt:setvarblock>

<mt:include name="include/header.tmpl">

<form id="sys_conf" action="<mt:var name="script_url">" method="post">
  <input type="hidden" name="__mode" value="save_cfg_system_mail" />
  <input type="hidden" name="return_args" value="<mt:var name="return_args" escape="html">" />
  <input type="hidden" name="magic_token" value="<mt:var name="magic_token">" />

  <mtapp:setting
     id="system_email_address"
     label="<__trans phrase="System Email">"
     hint="<__trans phrase="This email address is used in the 'From:' header of each email sent by Movable Type.  Email may be sent for password recovery, commenter registration, comment and trackback notification, user or IP address lockout, and a few other minor events.">"
     show_hint="1">
    <input type="text" name="system_email_address" id="system_email_address" class="text med required email"<mt:if name="system_email_address"> value="<mt:var name="system_email_address" escape="html">"</mt:if> /> <a href="#" id="send-test-email"><__trans phrase="Send Test Email"></a>
  </mt:app:setting>

  <mt:if name="mail_transfer" eq="sendmail">
    <mtapp:setting
       id="sendmail_path"
       label="<__trans phrase="sendmail Path">"
       hint="<__trans phrase="The physical file path for your sendmail binary.">"
       show_hint="1">       
      <input type="text" name="sendmail_path" id="sendmail_path" class="text full" value="<mt:var name="sendmail_path" escape="html">" />
    </mt:app:setting>
  <mt:elseif name="mail_transfer" eq="smtp">
    <mtapp:setting
       id="smtp_server"
       label="<__trans phrase="Outbound Mail Server">"
       hint="<__trans phrase="Address of your SMTP Server.">"
       show_hint="1">       
      <input type="text" id="smtp_server" class="text full" name="smtp_server" value="<mt:var name="smtp_server" escape="html">" />
    </mt:app:setting>
  
    <mtapp:setting
       id="smtp_port"
       label="<__trans phrase="Port number">"
       hint="<__trans phrase="Port number  of your SMTP Server.">"
       show_hint="1">       
      <input type="text" id="smtp_port" class="text num" name="smtp_port" value="<mt:var name="smtp_port" escape="html">" />
    </mt:app:setting>
  
    <mt:if name="has_net_smtp_auth">
      <mtapp:setting
         id="smtp_auth_username"
         label="<__trans phrase="SMTP Auth">"
         show_hint="0">
        <input type="checkbox" name="smtp_auth" id="smtp_auth" class="cb" value="1" <mt:if name="smtp_auth">checked</mt:if> />
        <label for="smtp_auth"><__trans phrase="Use SMTP Auth"></label>
      </mtapp:setting>
      <div id="smtpauth_params" <mt:unless name="smtp_auth">style="display: none"</mt:unless>>
        <mtapp:setting
           id="smtp_auth_username"
           label="<__trans phrase="SMTP Auth Username">"
           hint="<__trans phrase="Username for your SMTP Server.">"
           show_hint="1">
          <input type="text" id="smtp_auth_username" class="text full" name="smtp_auth_username" value="<mt:var name="smtp_auth_username" escape="html">" />
        </mtapp:setting>
  
        <mtapp:setting
           id="smtp_auth_password"
           label="<__trans phrase="SMTP Auth Password">"
           hint="<__trans phrase="Password for your SMTP Server.">"
           show_hint="1">
          <input type="password" id="smtp_auth_password" class="text full" name="smtp_auth_password" value="<mt:var name="smtp_auth_password" escape="html">" />
        </mtapp:setting>
  
        <mtapp:setting
           id="smtp_auth_ssl"
           label="<__trans phrase="SSL">"
           show_hint="0">
          <mt:unless name="has_net_smtp_ssl">
            <mtapp:statusmsg
               id="no_smtp_auth_ssl"
               class="info"
               can_close="0">
              <mt:var name="has_net_smtp_ssl_msg" escape="html">
            </mtapp:statusmsg>
          </mt:unless>
          <input type="checkbox" name="smtp_auth_ssl" id="smtp_auth_ssl" class="cb" value="1"<mt:if name="smtp_auth_ssl"> checked</mt:if><mt:unless name="has_net_smtp_ssl"> disabled="disabled"</mt:unless> />
          <label for="smtp_auth_ssl"><__trans phrase="Enable SMTP Auth with SSL"></label>
        </mtapp:setting>
  
        <mtapp:setting
           id="smtp_auth_tls"
           label="<__trans phrase="TLS">"
           show_hint="0">
          <mt:unless name="has_net_smtp_tls">
            <mtapp:statusmsg
               id="no_smtp_auth_tls"
               class="info"
               can_close="0">
              <mt:var name="has_net_smtp_tls_msg" escape="html">
            </mtapp:statusmsg>
          </mt:unless>
          <input type="checkbox" name="smtp_auth_tls" id="smtp_auth_tls" class="cb" value="1"<mt:if name="smtp_auth_tls"> checked</mt:if><mt:unless name="has_net_smtp_tls"> disabled="disabled"</mt:unless> />
          <label for="smtp_auth_tls"><__trans phrase="Enable SMTP Auth with TLS"></label>
        </mtapp:setting>
      </div>
    </mt:if>
  </mt:if>

<mt:setvarblock name="action_buttons">
  <button
     type="submit"
     accesskey="s"
     title="<__trans phrase="Save changes to these settings (s)">"
     class="save action primary button">
    <__trans phrase="Save Changes">
  </button>
</mt:setvarblock>
<mt:include name="include/actions_bar.tmpl" bar_position="bottom" hide_pager="1" settings_bar="1">
</form>

<div id="test-email-dialog">
  <form id="test_form" action="<mt:var name="script_url">" method="post">
    <input type="hidden" name="__mode" value="cfg_system_mail" />
    <input type="hidden" name="return_args" value="<mt:var name="return_args" escape="html">" />
    <input type="hidden" name="magic_token" value="<mt:var name="magic_token">" />

    <input type="hidden" name="system_email_address" value="" />
    <input type="hidden" name="sendmail_path" value="" />
    <input type="hidden" name="smtp_server" value="" />
    <input type="hidden" name="smtp_port" value="" />
    <input type="hidden" name="smtp_auth" value="" />
    <input type="hidden" name="smtp_auth_username" value="" />
    <input type="hidden" name="smtp_auth_password" value="" />
    <input type="hidden" name="smtp_auth_ssl" value="" />
    <input type="hidden" name="smtp_auth_tls" value="" />

    <mtapp:setting
       id="to_email_address"
       label="<__trans phrase="Send Email To">"
       label_class="top-class"
       hint="<__trans phrase="The email address that should receive a test email from Movable Type.">"
       show_hint="1">
      <input type="text" name="to_email_address" id="to-email-address" class="text full" />
    </mt:app:setting>
    <div class="dialog actions-bar">
      <button
         type="submit"
         class="action primary button">
        <__trans phrase="Send">
      </button>
    </div>
  </form>
</div>

<mt:setvarblock name="jq_js_include" append="1">
    jQuery('#test-email-dialog').dialog({
        bgiframe: true,
        title: '<__trans phrase="Send Test Email">',
        autoOpen: false,
        width: 450
    });
    jQuery('#send-test-email').click(function() {
        var $settings = jQuery('#sys_conf');
        var $testForm = jQuery('#test_form');
        if ( $settings.find('input:visible, select:visible').mtValidate('simple') ) {
            $testForm.find('input:[name="system_email_address"]').val( $settings.find('input:[name="system_email_address"]').val() );
             $testForm.find('input:[name="sendmail_path"]').val( $settings.find('input:[name="sendmail_path"]').val() );
            $testForm.find('input:[name="smtp_server"]').val( $settings.find('input:[name="smtp_server"]').val() );
            $testForm.find('input:[name="smtp_port"]').val( $settings.find('input:[name="smtp_port"]').val() );
            if ( $settings.find('input:[name="smtp_auth"]:checked').length )
                $testForm.find('input:[name="smtp_auth"]').val( '1' );
            else
                $testForm.find('input:[name="smtp_auth"]').val( '0' );
            $testForm.find('input:[name="smtp_auth_username"]').val( $settings.find('input:[name="smtp_auth_username"]').val() );
            $testForm.find('input:[name="smtp_auth_password"]').val( $settings.find('input:[name="smtp_auth_password"]').val() );
            if ( $settings.find('input:[name="smtp_auth_ssl"]:checked').length )
                $testForm.find('input:[name="smtp_auth_ssl"]').val( '1' );
            else
                $testForm.find('input:[name="smtp_auth_ssl"]').val( '0' );
            if ( $settings.find('input:[name="smtp_auth_tls"]:checked').length )
                $testForm.find('input:[name="smtp_auth_tls"]').val( '1' );
            else
                $testForm.find('input:[name="smtp_auth_tls"]').val( '0' );

            jQuery('#test-email-dialog').dialog('open');
        }
        return false;
    });

    jQuery.mtValidateAddRules({
  <mt:if name="mail_transfer" eq="sendmail">
        "#sendmail_path": function($e) {
            return $e.val().trim() == '' ? false : true;
        },
  </mt:if>
  <mt:if name="mail_transfer" eq="smtp">
        "#smtp_server": function($e) {
            return $e.val().trim() == '' ? false : true;
        },
        "#smtp_auth_username": function($e) {
            if ( jQuery('#smtp_auth').is(':checked') ) {
                return $e.val().trim() == '' ? false : true;
            }
            return true;
        },
        "#smtp_auth_password": function($e) {
            if ( jQuery('#smtp_auth').is(':checked') ) {
                return $e.val().trim() == '' ? false : true;
            }
            return true;
        }
  </mt:if>
    });

    jQuery.mtValidateAddMessages({
        "#system_email_address.required": '<__trans phrase="You must set system email address." escape="singlequotes">',
  <mt:if name="mail_transfer" eq="sendmail">
        "#sendmail_path": '<__trans phrase="You must set sendmail path." escape="singlequotes">',
  </mt:if>
  <mt:if name="mail_transfer" eq="smtp">
        "#smtp_server": '<__trans phrase="You must set SMTP server address." escape="singlequotes">',
        "#smtp_auth_username": '<__trans phrase="You must set username for SMTP server." escape="singlequotes">',
        "#smtp_auth_password": '<__trans phrase="You must set password for SMTP server." escape="singlequotes">'
  </mt:if>
    });

    jQuery('#sys_conf').submit( function () {
        if ( !jQuery(this).find('input:visible, select:visible').mtValidate('simple') ) return false;
    });

</mt:setvarblock>

<mt:include name="include/footer.tmpl">
