<style>
#youtube-search-box {
  margin-bottom: 10px;
}

#youtube-thumbnails {
  margin-bottom: 10px;
}

#youtube-pages{
  clear: both;
  text-align: center;
}

#youtube-thumbnails .youtube-thumbnail {
  float: left;
  padding: 5px;
  width: 110px;
  height: 110px;
  overflow: hidden;
}

#youtube-thumbnails .title {
  white-space: nowrap;
}

#youtube-thumbnails .selected {
  background-color: #CCCCFF;
}

#youtube-pages span.link {
  text-decoration: underline;
  color: #0000FF;
  cursor: pointer;
}
</style>

<mtapp:form id="start-youtube-form" name="start-youtube-form" mode="save_start_youtube">

  <div id="youtube-search-box">

    <input id="youtube-search-text" name="youtube_search_text" type="text" class="text short" />

    <input type="button" id="youtunbe-search-button" value="<__trans phrase="Search">" />

  </div>

  <div id="youtube-thumbnails"></div>

  <div id="youtube-pages"></div>

</mtapp:form>

<script type="text/javascript">
  jQuery(function() {
    var magic_token = '<mt:var name="magic_token">';
    var blog_id = '<mt:var name="blog_id">';

    function get_youtube_thumbnails( page_token, text ) {
      jQuery("#youtube-thumbnails").empty();
      jQuery("#youtube-pages").empty();

      jQuery("#youtube-thumbnails").html('<div id="progressbar" class="progressbar indeterminate"></div>');

      jQuery.ajax({
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
        async: true,
        url: ScriptURI,
        dataType: 'json',
        data: {
          __mode: 'get_youtube_list',
          magic_token: magic_token,
          blog_id: blog_id,
          text: text,
          page_token: page_token
        },
        success: function(data) {
          jQuery("#youtube-thumbnails").empty();

          var videos = data.result.videos;
          var thumbnails = jQuery('<div/>');

          if (videos.length > 0) {
            var count = 1;
            jQuery.each(videos, function (index) {
              if ( count == 6 ) {
                thumbnails.append(jQuery('<br/>').css('clear', 'both'));
              }
              var video_id = videos[index].id;
              thumbnails.append(
                jQuery('<div/>').addClass('youtube-thumbnail').attr({ id: "thumb-" + videos[index].id }).append(
                  jQuery('<img/>').attr({
                    src: videos[index].thumbnail,
                    alt: videos[index].title,
                    width: "110px",
                    height: "82px"
                  })
                ).append(
                  jQuery('<br/>')
                ).append(
                  jQuery('<span/>').addClass('title').text(videos[index].title)
                )
              );
              count++;
            });
            thumbnails.append(jQuery('<br/>').css('clear', 'both'));
            jQuery("#youtube-thumbnails").append(thumbnails);
            jQuery(".youtube-thumbnail").click( function() {
              if ( jQuery(this).hasClass("selected") ) {
                jQuery(this).removeClass("selected");
              }
              else {
                jQuery(this).addClass("selected");
              }
            });
            if ( data.result.prev_page_token ) {
              jQuery("#youtube-pages").append(
                jQuery('<span/>').attr({ id: 'youtube-prev-link' }).addClass('link').text('< prev')
              );
              jQuery('#youtube-prev-link').click(function() {
                get_youtube_thumbnails( data.result.prev_page_token, text );
              });
            }
            jQuery("#youtube-pages").append(
              jQuery('<span/>').text(" ")
            );
            if ( data.result.next_page_token ) {
              jQuery("#youtube-pages").append(
                jQuery('<span/>').attr({ id: 'youtube-next-link' }).addClass('link').text('next >')
              );
              jQuery('#youtube-next-link').click(function() {
                get_youtube_thumbnails( data.result.next_page_token, text );
              });
            }
          }
          else {
            jQuery("#youtube-thumbnails").text('<__trans phrase="Photo was not found.">');
          }
        },
        error: function(xhr, status, errorThrown) {
          if ( xhr.status == 401 ) {
            loginAgain(function(){
              $this.click();
            });
          }
          else
            generate_error(xhr.status+' '+errorThrown);
        }
      });
    }

    function generate_error(msg) {
      if ( jQuery('div.msg-error')[0] )
          return;
      jQuery('#msg-block').append('<div class="msg msg-error additem-error">'+msg+'</div>');
    }

    jQuery('#youtube-search-button').click( function() {
        var text = jQuery('#youtube-search-text').val();
        if (!text) {
          return;
        }
        get_youtube_thumbnails( '', text );
    });

    get_youtube_thumbnails();
  });
</script>
