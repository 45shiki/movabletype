<style>
#flickr-search-box {
  margin-bottom: 10px;
}

#flickr-thumbnails {
  margin-bottom: 10px;
}

#flickr-read-more{
  clear: both;
  text-align: center;
  margin-bottom: 50px;
}

#flickr-thumbnails .flickr-thumbnail {
  float: left;
  padding: 13px;
  width: 75px;
  height: 90px;
  overflow: hidden;
}

#flickr-thumbnails .title {
  white-space: nowrap;
}

#flickr-thumbnails .selected {
  background-color: #cae5f8;
}

#flickr-thumbnails .selected img {
  -webkit-filter: brightness(0.5);
  -moz-filter: brightness(0.5);
  -o-filter: brightness(0.5);
  -ms-filter: brightness(0.5);
  filter: brightness(0.5);
}

#flickr-read-more span.link {
  text-decoration: underline;
  color: #0000FF;
  cursor: pointer;
}
</style>

<form>

  <div id="flickr-search-box">

    <select id="photoset" name="photoset" style="width: 200px;">
      <option value="0"><__trans phrase="Select Photoset"></option>
    <mt:loop name="photosets">
      <option value="<mt:var name="id">"><mt:var name="title"></option>
    </mt:loop>
    </select>

    <input type="button" id="select-button" value="<__trans phrase="Select">" />

    <input id="search-text" name="search_text" type="text" class="text short" />

    <input type="button" id="search-button" value="<__trans phrase="Search">" />

  </div>

  <div id="flickr-thumbnails"></div>

  <div id="flickr-read-more"></div>

</form>

<script type="text/javascript">
  jQuery(function() {
    var magic_token = '<mt:var name="magic_token">';
    var blog_id = '<mt:var name="blog_id">';

    function get_flickr_thumbnails( method, page, param ) {
      if (!page)
        page = 1;

      jQuery.ajax({
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
        async: true,
        url: ScriptURI,
        dataType: 'json',
        data: {
          __mode: 'get_flickr_list',
          magic_token: magic_token,
          blog_id: blog_id,
          method: method,
          page: page,
          param: param
        },
        success: function(data) {
          var photos = data.result.photos;
          var thumbnails = jQuery('<div/>').attr({ id: "flickr-page-" + page });

          if (photos.length > 0) {
            var count = 1;
            jQuery.each(photos, function (index) {
              if ( count == 6 ) {
                thumbnails.append(jQuery('<br/>').css('clear', 'both'));
              }
              thumbnails.append(
                jQuery('<div/>').addClass('flickr-thumbnail').attr({ id: "thumb-" + photos[index].id }).append(
                  jQuery('<img/>').attr({
                    id: photos[index].id,
                    src: "<$mt:var name="static_uri"$>plugins/MTAssetoEmbed/img/flickr_blank_thumbnail.png",
                    alt: photos[index].title
                  })
                ).append(
                  jQuery('<br/>')
                ).append(
                  jQuery('<span/>').addClass('title').text(photos[index].title)
                )
              )
              count++;
            });
            jQuery("#flickr-thumbnails").append(thumbnails);
            jQuery.each(photos, function (index) {
              var photo_id = photos[index].id;
              jQuery.ajax({
                type: 'POST',
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                async: true,
                url: ScriptURI,
                dataType: 'json',
                data: {
                  __mode: 'get_flickr_thumbnail',
                  magic_token: magic_token,
                  blog_id: blog_id,
                  photo_id: photo_id
                },
                success: function(data) {
                  jQuery("#" + photo_id).attr({ src: data.result.thumbnail });
                  jQuery("#thumb-" + photo_id).click( function() {

                    // Select thumbnail
                    if ( jQuery(this).hasClass("selected") ) {
                      jQuery(this).removeClass("selected");
                    }
                    else {
                      jQuery(this).addClass("selected");
                    }

                    // Submit button
                    if (jQuery("#flickr-thumbnails .selected").length > 0) {
                      // Enable submit button
                      jQuery('.actions-bar button.primary')
                        .removeAttr('disabled')
                        .removeClass('disabled');
                    }
                    else {
                      // Disable submit button
                      jQuery('.actions-bar button.primary')
                        .attr('disabled')
                        .addClass('disabled');
                    }
                  });
                },
                error: function(xhr, status, errorThrown) {
                  if ( xhr.status == 401 ) {
                    loginAgain(function(){
                      $this.click();
                    });
                  }
                  else
                    generate_error(xhr.status+' '+errorThrown);
                }
              });
            });
            jQuery("#flickr-thumbnails").append(thumbnails);
            jQuery("#flickr-read-more").empty();
            if ( data.result.page < data.result.pages ) {
              jQuery("#flickr-read-more").append(
                jQuery('<span/>').addClass('link').text('<__trans phrase="Read More">')
              );
              jQuery('#flickr-read-more').off("click");
              jQuery('#flickr-read-more').click(function() {
                get_flickr_thumbnails( method, parseInt(data.result.page) + 1, param );
              });
            }
	  }
          else {
            jQuery("#flickr-thumbnails").text('<__trans phrase="Photo was not found.">');
          }
        },
        error: function(xhr, status, errorThrown) {
          if ( xhr.status == 401 ) {
            loginAgain(function(){
              $this.click();
            });
          }
          else
            generate_error(xhr.status+' '+errorThrown);
        }
      });
    }

    function generate_error(msg) {
      if ( jQuery('div.msg-error')[0] )
          return;
      jQuery('#msg-block').append('<div class="msg msg-error additem-error">'+msg+'</div>');
    }

    jQuery('#select-button').click( function() {
        var photoset_id = jQuery('#photoset option:selected').val();
        if ( photoset_id === '0' ) {
          alert("<__trans phrase="Photoset was not selected.">");
          return;
        }
        jQuery("#flickr-thumbnails").empty();
        get_flickr_thumbnails( 'photoset', 1, photoset_id );
    });

    jQuery('#search-button').click( function() {
        var keyword = jQuery('#search-text').val();
        if (!keyword) {
          return;
        }
        jQuery("#flickr-thumbnails").empty();
        get_flickr_thumbnails( 'search', 1, keyword );
    });

    jQuery('#select_asset').submit( function() {
      if ( !jQuery('#flickr-panel').hasClass('hidden') ) {
        var urls = [];
        jQuery("#flickr-thumbnails").find(".selected").each( function() {
          urls.push( jQuery(this).find("img").attr("src") );
        });
        jQuery.ajax({
          type: 'POST',
          contentType: 'application/x-www-form-urlencoded; charset=utf-8',
          async: false,
          url: ScriptURI,
          dataType: 'json',
          data: {
            __mode: 'add_asset_oembed_multi',
            magic_token: magic_token,
            blog_id: blog_id,
            urls: jQuery.toJSON(urls)
          },
          success: function(data) {
            var ids = data.result.ids;
            jQuery('#select_asset input[name="id"]').val(ids.join(','));
          },
          error: function(xhr, status, errorThrown) {
            if ( xhr.status == 401 ) {
              loginAgain(function(){
                $this.click();
              });
            }
            else
              generate_error(xhr.status+' '+errorThrown);
          }
        });
      }
    });

    get_flickr_thumbnails('search');
  });
</script>
