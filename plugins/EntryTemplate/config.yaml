id: EntryTemplate
name: EntryTemplate
version: 1.01

l10n_class: EntryTemplate::L10N

schema_version: 1.01
object_types:
    entry_template: EntryTemplate::EntryTemplate

applications:
    cms:
        menus:
            entry_template:
                label: Entry Template
                order: 310

            entry_template:manage:
                label: Manage
                order: 100
                mode: list
                args:
                    _type: entry_template
                condition: |
                    sub {
                        require EntryTemplate::App;
                        my $app = MT->instance;

                        return 0 unless EntryTemplate::App::is_enabled($app);

                        if ($app->blog) {
                            return EntryTemplate::App::can_edit_entry_template( $app->permissions, undef, $app->user );
                            return EntryTemplate::App::can_view_entry_template( $app->permissions, undef, $app->user );
                        }

                        require MT::Permission;
                        my $iter = MT::Permission->load_iter(
                            {   author_id => $app->user->id,
                                    blog_id => { not => 0 }
                            }
                        );

                        my $cond;
                        while ( my $p = $iter->() ) {
                            return 1
                                if $p->can_do('manage_pages') || $p->can_do('create_post');
                        }

                        return 0;
                    }
                view:
                    - system
                    - blog
                    - website

            entry_template:create:
                label: New
                order: 200
                mode: view
                args:
                    _type: entry_template
                condition: |
                    sub {
                        require EntryTemplate::App;
                        my $app = MT->instance;

                        return 0 unless EntryTemplate::App::is_enabled($app);

                        EntryTemplate::App::can_edit_entry_template( $app->permissions, undef, $app->user );
                    }
                view:
                    - website
                    - blog

callbacks:
    MT::App::CMS::template_param.edit_entry: $EntryTemplate::EntryTemplate::App::param_edit_entry
    MT::App::CMS::cms_edit.entry_template: $EntryTemplate::EntryTemplate::App::cms_edit_entry_template
    MT::App::CMS::list_template_param.entry_template: $EntryTemplate::EntryTemplate::App::list_template_param
    api_save_filter.entry_template: $EntryTemplate::EntryTemplate::EntryTemplate::save_filter
    cms_save_filter.entry_template: $EntryTemplate::EntryTemplate::EntryTemplate::save_filter

    cms_save_permission_filter.entry_template: $EntryTemplate::EntryTemplate::App::save_permission_filter
    cms_view_permission_filter.entry_template: $EntryTemplate::EntryTemplate::App::view_permission_filter
    cms_delete_permission_filter.entry_template: $EntryTemplate::EntryTemplate::App::delete_permission_filter
    cms_pre_load_filtered_list.entry_template: $EntryTemplate::EntryTemplate::App::cms_pre_load_filtered_list
    cms_filtered_list_param.entry_template: $EntryTemplate::EntryTemplate::App::filtered_list_param


listing_screens:
    entry_template: $EntryTemplate::EntryTemplate::App::listing_screens

list_properties:
    entry_template: $EntryTemplate::EntryTemplate::EntryTemplate::list_props

system_filters:
    entry_template: $EntryTemplate::EntryTemplate::App::system_filters

list_actions:
    entry_template: $EntryTemplate::EntryTemplate::App::list_actions
