<h2><__trans phrase="Google Analytics"></h2>

<mt:If name="missing_modules">
<p><mt:Var name="missing_modules" /></p>
<mt:Else>

<mtapp:settinggroup id="google-analytics-settings">

<mtapp:setting
   id="ga_redirect_uri"
   label="<__trans phrase="The redirect URI of the OAuth2 application">"
   show_hint="0">
    <input type="text" id="ga_redirect_uri" readonly="readonly" value="<mt:Var name="redirect_uri" encode_html="1" />" />
</mtapp:setting>

<mtapp:setting
   id="ga_client_id"
   label="<__trans phrase="The client ID of the OAuth2 application">"
   show_hint="0">
    <input type="text" id="ga_client_id" name="ga_client_id" value="<mt:Var name="ga_client_id" encode_html="1" />" />
</mtapp:setting>

<mtapp:setting
   id="client_secret"
   label="<__trans phrase="The client secret of the OAuth2 application">"
   show_hint="0">
    <input type="text" id="ga_client_secret" name="ga_client_secret" value="<mt:Var name="ga_client_secret" encode_html="1" />" />
</mtapp:setting>

<mtapp:setting
   id="ga_profile_name"
   label="<__trans phrase="The name of the profile">"
   show_hint="0">
   <input type="text" id="ga_profile_name" name="ga_profile_name" readonly="readonly" value="<mt:Var name="ga_profile_name" encode_html="1" />" />
</mtapp:setting>

<mtapp:setting
   id="ga_profile_web_property_id"
   label="<__trans phrase="The web property ID of the profile">"
   show_hint="0">
    <input type="text" id="ga_profile_web_property_id" name="ga_profile_web_property_id" readonly="readonly" value="<mt:Var name="ga_profile_web_property_id" encode_html="1" />" />
</mtapp:setting>

<input type="hidden" id="ga_profile_id" name="ga_profile_id" value="<mt:Var name="ga_profile_id" encode_html="1" />" />

<mtapp:setting
   id="ga_select_profile"
   label=""
   show_hint="0">
    <a href="#" id="ga_select_profile"><__trans phrase="Associate profile" /></a>
    <a href="#" id="ga_clear_profile"><__trans phrase="Clear profile" /></a>
</mtapp:setting>

<input type="hidden" id="ga_dialog_url" value="<mt:Var name="dialog_url" encode_html="1" />" />
<input type="hidden" id="ga_configured_client_id" value="<mt:Var name="configured_client_id" encode_html="1" />" />
<input type="hidden" id="ga_configured_client_secret" value="<mt:Var name="configured_client_secret" encode_html="1" />" />
<script type="text/javascript">
jQuery(function($) {
    var redirectUri = $('#ga_redirect_uri').val();
    if (! redirectUri.match(/^https?:\/\//)) {
        redirectUri =
            redirectUri.replace(/^\/?/, location.protocol + '//' + location.host + '/');
        $('#ga_redirect_uri').val(redirectUri);
    }

    $('#ga_client_id, #ga_client_secret')
        .on('input click keyup change', function() {
            if (
                $('#ga_client_id').val() &&
                $('#ga_client_secret').val()
            ) {
                $('#ga_select_profile').removeClass('disabled');
            }
            else {
                $('#ga_select_profile').addClass('disabled');
            }
        })
        .triggerHandler('input');

    $('#ga_select_profile').click(function() {
        var clientId     = $('#ga_client_id').val();
        var clientSecret = $('#ga_client_secret').val();

        if (! clientId || ! clientSecret) {
            return false;
        }

        if (clientId === $('#ga_configured_client_id').val()) {
            var dialogUrl = $('#ga_dialog_url').val();

            $.fn.mtDialog.close();
            $.fn.mtDialog.open(dialogUrl + '&client_id=' + clientId);
        }
        else {
            var url = '<mt:Var name="authorize_url" encode_js="1" />'
                .replace('__client_id__', clientId)
                .replace('__redirect_uri__', redirectUri);
            window.open(
                url, 'google_analytics_authorize',
                'width=700, height=500, menubar=no, toolbar=no, scrollbars=yes'
            );
        }

        return false;
    });

    $($('#ga_client_id').get(0).form).on('submit', function() {
        var clientId     = $('#ga_client_id').val();
        var clientSecret = $('#ga_client_secret').val();
        if (
            (clientId && clientId !== $('#ga_configured_client_id').val()) ||
            (clientSecret && clientSecret !== $('#ga_configured_client_secret').val())
        ) {
            return window.confirm('<__trans phrase="Client ID or client secret for Google Analytics was changed, but profile was not updated. Are you sure you want to save these informations?" encode_html="1">');
        }
    });
});
</script>

</mtapp:settinggroup>
</mt:If>
